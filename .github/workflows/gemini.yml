name: Gemini

on:
  workflow_dispatch:

jobs:
  build-windows-x86:
    # 保持使用 windows-latest，它现在是 Windows 2022
    runs-on: windows-latest 

    steps:
      - name: Checkout MariaDB 10.3.33
        uses: actions/checkout@v4
        with:
          repository: MariaDB/server
          ref: mariadb-10.3.33
          submodules: 'recursive'

      - name: Install Dependencies (Perl & Bison)
        run: |
          choco install strawberryperl
          choco install winflexbison
        shell: pwsh

      # 3. 设置 32-bit (x86) 编译环境
      #    我们使用 VS 2022，因为它是 windows-latest (Windows 2022) 
      #    运行器上默认安装的版本。
      - name: Setup MSVC x86 (32-bit) Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86
          # 修正：从 '2019' 改为 '2022'
          vsversion: '2022' 

      # 4. 配置 CMake (生成 32-bit 项目)
      - name: Configure CMake
        run: |
          mkdir build
          cd build
          
          # 修正：将 cmake 命令合并为一行，以避免 'cmd' 和 'pwsh' 之间的 ^ 字符转义问题
          cmake .. -G "Visual Studio 17 2022" -A Win32 -DBUILD_CONFIG=mysql_release -DWITH_SSL=bundled -DWITH_UNIT_TESTS=OFF
        
        # 关键：我们仍然必须使用 'cmd' shell，
        # 因为上一步 (Setup MSVC) 设置的环境变量是为 'cmd' 准备的。
        shell: cmd

      # 5. 编译并打包 (Build & Package)
      - name: Build and Package
        run: |
          cd build
          cmake --build . --config Release --target PACKAGE
        shell: cmd

      # 6. 上传构建产物 (Artifact)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mariadb-10.3.33-win32-package
          path: build/mariadb-*.zip
          if-no-files-found: error
